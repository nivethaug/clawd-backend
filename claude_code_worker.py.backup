"""
Claude Code Background Worker Module.
Handles background execution of Claude Code for website project initialization.
"""

import threading
import subprocess
import logging
from typing import Optional

from database import get_db

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


def run_claude_code_background(project_id: int, project_path: str, project_name: str, description: Optional[str] = None, session_name: str = None) -> threading.Thread:
    """
    Run Claude Code initialization in a background thread.

    This function:
    - Creates and starts a background thread
    - Executes Claude Code wrapper script
    - Updates project status in database (creating â†’ ready/failed)
    - Creates new DB session inside thread (thread safety)
    - Handles errors safely

    Args:
        project_id: Project ID from database
        project_path: Absolute path to project folder
        project_name: Project name
        description: Project description (optional)
        session_name: Unique session name for Claude Code (for tracking)

    Returns:
        Thread object that has been started

    Thread Safety:
        - Creates new database connection inside thread
        - Does NOT reuse request DB session
        - Closes DB session after completion
    """

    def _worker():
        """Worker function that runs in background thread."""
        try:
            # Log start
            logger.info(f"Starting Claude Code background worker for project {project_id}")
            logger.info(f"Project path: {project_path}")
            logger.info(f"Session name for tracking: {session_name}")

            # Run Claude Code step-by-step wrapper script
            # The wrapper breaks initialization into 5 focused tasks
            # Each task is a separate Claude Code call with clear tracking
            logger.info(f"Executing: python3 claude_wrapper_final.py {project_id} {project_path} '{project_name}'")

            result = subprocess.run(
                ["python3", "/root/clawd-backend/claude_wrapper_final.py", str(project_id), project_path, project_name, description or ""],
                capture_output=True,
                text=True,
                timeout=3600  # 60 minutes total (10 min per task)
            )

            # Check result
            if result.returncode == 0:
                # Success (wrapper updates status internally)
                logger.info(f"Claude Code wrapper completed successfully for project {project_id}")
                logger.info(f"Output: {result.stdout[-500:]}")  # Log last 500 chars
            else:
                # Failure
                logger.error(f"Claude Code wrapper failed for project {project_id}")
                logger.error(f"Return code: {result.returncode}")
                logger.error(f"Error output: {result.stderr}")

                # Update project status to 'failed' in NEW DB session
                # (wrapper should handle this, but we double-check)
                try:
                    with get_db() as conn:
                        conn.execute(
                            "UPDATE projects SET status = 'failed' WHERE id = ?",
                            (project_id,)
                        )
                        conn.commit()
                        logger.info(f"Project {project_id} status updated to 'failed' (safety check)")
                except Exception as db_error:
                    logger.error(f"Failed to update project status: {db_error}")

        except subprocess.TimeoutExpired:
            # Timeout
            logger.error(f"Claude Code wrapper timeout for project {project_id}")

            # Update project status to 'failed' in NEW DB session
            try:
                with get_db() as conn:
                    conn.execute(
                        "UPDATE projects SET status = 'failed' WHERE id = ?",
                        (project_id,)
                    )
                    conn.commit()
                    logger.info(f"Project {project_id} status updated to 'failed' (timeout)")
            except Exception as db_error:
                logger.error(f"Failed to update project status: {db_error}")

        except Exception as e:
            # Unexpected error
            logger.error(f"Claude Code wrapper worker error for project {project_id}: {e}")

            # Update project status to 'failed' in NEW DB session
            try:
                with get_db() as conn:
                    conn.execute(
                        "UPDATE projects SET status = 'failed' WHERE id = ?",
                        (project_id,)
                    )
                    conn.commit()
                    logger.info(f"Project {project_id} status updated to 'failed' (error)")
            except Exception as db_error:
                logger.error(f"Failed to update project status: {db_error}")

        finally:
            # Thread cleanup (DB session is auto-closed by get_db context manager)
            logger.info(f"Claude Code worker thread for project {project_id} finished")

    # Create and start thread
    thread = threading.Thread(target=_worker, daemon=True)
    thread.start()
    logger.info(f"Background thread started for project {project_id}")

    return thread
